version: 2

commands:
  open_browser:
    parameters:
      browser:
        type: string
        default: "google-chrome"
      background:
        type: string
        default: "true"
    steps:
      - run:
          command: "<<parameters.browser>> '<<parameters.url>>'"
          background: "<<parameters.background>>"

  open_zen_flatpak:
    steps:
      - run:
          command: "flatpak run io.github.zen_browser.zen --new-tab '<<parameters.url>>'"
          background: "true"

  save_url_markdown:
    parameters:
      output_dir:
        type: string
        default: "~/Documents/ReadLater"
    steps:
      - run:
          command: "url-hash <<parameters.url>>"
          save_to: "custom_hash"
      - run: "curl -sL '<<parameters.url>>' -o page.html"
      - run: "go-read-md --output <<parameters.output_dir>> --url '<<parameters.url>>' --input page.html --filename '<<parameters.custom_hash>>.md'"

  save_html_markdown:
    parameters:
      output_dir:
        type: string
        default: "~/Documents/ReadLater"
    steps:
      - run: "go-read-md --output <<parameters.output_dir>> --url '<<parameters.url>>' --input '{html}' --filename '<<parameters.url_hash>>.md'"

jobs:
  default_firefox:
    steps:
      - open_browser:
          browser: "firefox"

  social_zen:
    steps:
      - open_zen_flatpak

  read_markdown:
    steps:
      - save_url_markdown

  read_html:
    steps:
      - save_html_markdown

workflows:
  smart_routing:
    jobs:
      # 1. URL to Markdown (Reading list)
      - read_markdown:
          match: "(?i)(medium\\.com|generic-blog\\.com)"

      # 2. URL to Markdown (Reading list - HTML for paywalls/dynamic sites)
      - read_html:
          match: "(?i)(nytimes\\.com|wsj\\.com|bloomberg\\.com)"

      # 3. Chrome to Zen (Video/Social)
      - social_zen:
          match: "(?i)(youtube\\.com|twitch\\.tv)"

      # 4. Default: Chrome to Firefox
      - default_firefox:
          match: ".*"
